#!/bin/sh

# קבצים ששונו או נוספו וצריכים לעבור בדיקות
FILES=$(git diff --cached --name-only --diff-filter=ACMR | sed 's| |\\ |g')
[ -z "$FILES" ] && exit 0

# הפעלת Prettier על הקבצים ששונו או נוספו
echo "$FILES" | xargs ./node_modules/.bin/prettier --ignore-unknown --write

# בדיקת ESLint על קבצי JavaScript ו-TypeScript ששונו או נוספו
echo -e "\nValidating Javascript & Typescript with eslint:"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E "\.jsx?$|\.tsx?$|\.js$|\.ts$")

if [ -n "$STAGED_FILES" ]; then
  ESLINT_OUTPUT=$(echo "$STAGED_FILES" | xargs ./node_modules/.bin/eslint --fix --format json)
  
  if echo "$ESLINT_OUTPUT" | grep -q '"errorCount": [1-9]'; then
    echo -e "ESLint found errors, aborting commit."
    echo "$ESLINT_OUTPUT" | ./node_modules/.bin/eslint-formatter-friendly
    exit 1
  else
    echo -e "ESLint validation completed successfully."
  fi
fi


# הוספת הקבצים ששונו או נוספו מחדש ל-stage
echo "$FILES" | xargs git add
echo "$STAGED_FILES" | xargs git add

exit 0
