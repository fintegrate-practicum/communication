#!/bin/sh
# . "$(dirname -- "$0")/_/husky.sh"

# Exit if no files are staged for commit
FILES=$(git diff --cached --name-only --diff-filter=ACMR | sed 's| |\\ |g')
[ -z "$FILES" ] && exit 0

# Prettify all staged files
echo "$FILES" | xargs ./node_modules/.bin/prettier --ignore-unknown --write

# Validate JavaScript and TypeScript with ESLint, fixing issues automatically
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.jsx{0,1}$|\.tsx{0,1}$")
# Run ESLint with autofixing and turn off 'no-unused-vars' rule to ignore unused variables
echo "$STAGED_FILES" | xargs ./node_modules/.bin/eslint --fix --rule '{ "no-unused-vars": "off" }'

# Check for unused variables and remove them from staged files
UNUSED_VARS=$(echo "$STAGED_FILES" | xargs ./node_modules/.bin/eslint --print-config /dev/null | grep -A1 'no-unused-vars' | tail -n1 | sed 's/[^"]*"\([^"]*\)".*/\1/')
if [ -n "$UNUSED_VARS" ]; then
  echo "Removing unused variables: $UNUSED_VARS"
  for VAR in $UNUSED_VARS; do
    sed -i "/$VAR/d" $STAGED_FILES
  done
fi

# Add back the modified/prettified files to staging
echo "$FILES" | xargs git add
echo "$STAGED_FILES" | xargs git add

exit $?
